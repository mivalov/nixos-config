<h1 align="center">:snowflake: NixOS config :snowflake:</h1>

<p align="center">
  <image src="https://builtwithnix.org/badge.svg" alt="Built with Nix">
</p>

## About

Flake-based NixOS setup with per-host configs and Home-Manager as a NixOS module.

## Project structure

- `flake.nix` - entrypoint for dynamically included hosts and home configurations
- `flake.lock` - pinned revisions of all inputs for reproducible builds
- `hosts/` - holds configurations for each machine, including shared (common) configurations and machine-specific configurations
  - `common/` - shared (common) configurations used by multiple machines
    - `global/` - configs present on all hosts
    - `optional/` - optional configs enabled per host as needed
    - `users/` - holds multiple user definitions + HM wiring
      - `<user>/default.nix` - user definition + HM wiring
  - `<host>/` - a specific host machine
    - `default.nix` - host entry (imports common packages + users + host-specific config)
    - `hardware-configuration.nix` - generated by `nixos-generate-config`
    - `<file>.nix` - additional host-specific configuration files
- `home/` - contains Home-Manager configurations
  - `common/` - shared (common) HM configurations, which can be imported by all users
    - `global/default.nix` - core HM configurations, present for all users
    - `optional/` - optional HM configs (features) enabled for one or more users as needed
  - `<user>/` - user folder, contains user-specific and host-specific configurations
    - `global/default.nix` - shared HM configs for the user across machines (e.g. shell)
    - `optional/` - optional HM configs (features) enabled for one or more hosts as needed
    - `<host>.nix` - host-specific HM configs/overrides for the user (e.g. E-Mail in Git)
- `overlays/` - nixpkgs overlays, used to modify upstream packages
- `pkgs/` - custom package definitions

### Adding a new host

1. Make sure to enable experimental nix CLI and flakes (in `/etc/nixos/configuration.nix`):
    - `nix.settings.experimental-features = [ "nix-command" "flakes" ];`
    - optionally, add vim/wget/curl, etc. or update  `networking.hostName`
    - run `sudo nixos-rebuild switch`
2. Create `hosts/<new-host>/{default.nix,hardware-configuration.nix}` and possibly other `*.nix` files:
    - first, copy existing configs: `cp /etc/nixos/*.nix hosts/<new-host>/`
    - then you can build on top of them
3. In `hosts/<new-host>/default.nix` import:
    - `../common/global`
    - one or more files from `../common/optional/*.nix` as needed
    - the right user module(s) from `../common/users/...`
4. When Home Manager is enabled, make sure to add `home/<user>/<new-host>.nix`
5. Run `sudo nixos-rebuild switch --flake .#<new-host>`

## Basic Nix/NixOS and HM commands

```bash
# Format *.nix files
nix fmt

# Check whether the flake can be evaluated successfully
nix flake check

# Update flake inputs
nix flake update

# Build system configurations and switch
sudo nixos-rebuild switch --flake .#<host>

# List available generations
nixos-rebuild list-generations

# Alternative command to list available generations
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

# View all available historical versions
nix profile history --profile /nix/var/nix/profiles/system

# Switch back to previous system generation
sudo nixos-rebuild switch --flake .#<host> --rollback
```

### Safe HM commands

Home Manager is used as a module, so we must avoid `home-manager switch` on NixOS systems.

```bash
# List generations
home-manager generations

# Build activation (without apply), then preview
home-manager build --flake .#<user>@<host>
./result/activate --dry-run
```

### Toubleshooting

```bash
# Open the configuration in nix repl
nixos-rebuild repl --flake .

# Build only
sudo nixos-rebuild build --flake .

# Display diff
nix store diff-closures /run/current-system ./result

# Preview dry-run
sudo ./result/bin/switch-to-configuration dry-activate

# On success, apply the build
sudo nixos-rebuild switch --flake .

# Discard the build
rm -f ./result
nix store gc
```

#### Check differences between two generations

```bash
# Check diff between the 2nd generation (previous) and the current one
nix store diff-closures /nix/var/nix/profiles/system-2-link /run/current-system

# The same result as previous command
nix store diff-closures /nix/var/nix/profiles/system-2-link /nix/var/nix/profiles/system
```

## Home Manager on non-NixOS system (e.g. work-host)

1. Install Nix and enable flakes
2. Clone the repo and cd into its directory
3. Apply home config without HM CLI
    - `nix run .#homeConfigurations."<user>@<work-host>".activationPackage`
4. Subsequent HM configs can now be applied with the HM CLI
    - `home-manager switch --flake .#<user>@<work-host>`

### Basic HM commands

The following commands are only for non-NixOS systems and after bootstrap.

```bash
# Apply changes
home-manager switch --flake .#<user>@<work-host>

# Only build changes: ./result/activate --dry-run
home-manager build --flake .#<user>@<work-host>

# List HM config generations
home-manager generations

# Expire generations older than 14 days
home-manager expire-generations --older-than 14d

# Remove expired generations and old packages
nix store gc
```
