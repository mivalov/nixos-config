<h1 align="center">:snowflake: NixOS config :snowflake:</h1>

<p align="center">
  <image src="https://builtwithnix.org/badge.svg" alt="Built with Nix">
</p>

## About

Flake-based NixOS setup with per-host configs and Home-Manager as a NixOS module.

## Project structure

- `flake.nix` - entrypoint for dynamically included hosts and home configurations
- `flake.lock` - pinned revisions of all inputs for reproducible builds
- `hosts/` - holds configurations for each machine, including shared (common) configurations and machine-specific configurations
  - `common/` - shared (common) configurations used by multiple machines
    - `global/` - configs present on all hosts
    - `optional/` - optional configs enabled per host as needed
    - `users/` - holds multiple user definitions + HM wiring
      - `<user>/default.nix` - user definition + HM wiring
  - `<host>/` - a specific host machine
    - `default.nix` - host entry (imports common packages + users + host-specific config)
    - `hardware-configuration.nix` - generated by `nixos-generate-config`
    - `<file>.nix` - additional host-specific configuration files
- `home/` - contains user dotfiles (Home-Manager)
  - `<user>/` - user folder
    - `global/default.nix` - shared configs for the user across machines (e.g. shell)
    - `<host>.nix` - host-specific configs/overrides for the user (e.g. E-Mail in Git)
- `overlays/` - nixpkgs overlays, used to modify upstream packages
- `pkgs/` - custom package definitions

### Adding a new host

1. Create `hosts/<new-host>/{default.nix,hardware-configuration.nix}` and possibly other `*.nix` files
2. In `hosts/<new-host>/default.nix` import:
  - `../common/global`
  - one or more files from `../common/optional/*.nix` as needed
  - the right user module(s) from `../common/users/...`
3. Run `sudo nixos-rebuild switch --flake .#<new-host>`

## Basic Nix/NixOS and HM commands

```bash
# Format *.nix files
nix fmt

# Check whether the flake can be evaluated successfully
nix flake check

# Update flake inputs
nix flake update

# Build system configurations and switch
sudo nixos-rebuild switch --flake .#<host>

# List available generations
nixos-rebuild list-generations

# Switch back to previous system generation
sudo nixos-rebuild switch --rollback
```

### Safe HM commands

Home Manager is used as a module, so we must avoid `home-manager switch` on NixOS systems.

```bash
# news
home-manager news

# list generations
home-manager generations

# build activation (without apply), then preview
home-manager build --flake .#<user>@<host>
./result/activate --dry-run
```

### Toubleshooting

```bash
# build only
sudo nixos-rebuild build --flake .

# display diff
nix store diff-closures /run/current-system ./result

# preview dry-run
sudo ./result/bin/switch-to-configuration dry-activate

# on success, apply the build
sudo nixos-rebuild switch --flake .

# discard the build
rm -f ./result
nix store gc
```

## Home Manager on non-NixOS system (e.g. work-host)

1. Install Nix and enable flakes
2. Clone the repo and cd into its directory
3. Apply home config without HM CLI
  - `nix run .#homeConfigurations."<user>@<work-host>".activationPackage`
4. Subsequent HM configs can now be applied with the HM CLI
  - `home-manager switch --flake .#<user>@<work-host>`

### Basic HM commands

The following commands are only for non-NixOS systems and after bootstrap.

```bash
# apply changes
home-manager switch --flake .#<user>@<work-host>

# only build changes: ./result/activate --dry-run
home-manager build --flake .#<user>@<work-host>

# list HM config generations
home-manager generations

# expire generations older than 14 days
home-manager expire-generations --older-than 14d

# remove expired generations and old packages
nix store gc
```
